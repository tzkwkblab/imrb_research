# メイン実験再実行 実装計画

## 1. 実験概要

### 1.1 目的
メイン実験を理想パラメータで再実行し、論文執筆に必要な正確な結果を取得する。

### 1.2 実験数
**総実験数: 36実験**

| データセット | アスペクト数 | 実験数 |
|------------|-----------|--------|
| SemEval | 4 | 4 |
| GoEmotions | 28 | 28 |
| Steam | 4 | 4 |
| **合計** | **36** | **36** |

**除外データセット**: Amazon (5実験), Retrieved Concepts/COCO (10実験)

## 2. パラメータ設定

### 2.1 理想パラメータ（再実行用）

| パラメータ | 実際の設定 | 理想の設定 | 変更要否 |
|-----------|----------|----------|---------|
| **Few-shot** | 1-shot | **0-shot** | ✅ 変更必要 |
| **max_tokens** | 100 | **2000** | ✅ 変更必要 |
| **temperature** | 0.7 | **0.0** | ✅ 変更必要 |
| **group_size** | 100 | 100 | - |
| **LLM評価** | 有効 | 有効 | - |
| **GPTモデル** | gpt-4o-mini | gpt-4o-mini | - |

### 2.2 パラメータ詳細

- **Few-shot**: 0（例題なし）
- **max_tokens**: 2000（より長い出力を許可）
- **temperature**: 0.0（一貫性重視、決定論的出力）
- **group_size**: 100（固定）
- **LLM評価**: 有効（gpt-4o-mini, temperature=0.0）
- **GPTモデル**: gpt-4o-mini（固定）

## 3. 実装が必要な項目

### 3.1 ディレクトリ構造の作成

```
論文/結果/追加実験/main_experiment_rerun/
├── README.md                          # 実験説明と実行手順
├── 実験パラメータ.md                   # パラメータ詳細
├── マトリックス/
│   └── main_experiment_matrix.json    # 実験マトリックス
└── 実行ファイル/
    └── generate_main_experiment_matrix.py  # マトリックス生成スクリプト
```

### 3.2 マトリックス生成スクリプトの作成

**ファイル**: `実行ファイル/generate_main_experiment_matrix.py`

**機能**:
- SemEval: 4アスペクト（food, service, battery, screen）
- GoEmotions: 28アスペクト（全感情カテゴリ）
- Steam: 4アスペクト（gameplay, visual, story, audio）
- パラメータ設定: few_shot=0, temperature=0.0, max_tokens=2000

**実験ID命名規則**:
- SemEval: `semeval_{domain}_{aspect}_0_4o-mini_word`
- GoEmotions: `goemotions_{aspect}_0_4o-mini_word`
- Steam: `steam_{aspect}_0_4o-mini_word`

### 3.3 バッチ実行スクリプトの修正

**ファイル**: `src/analysis/experiments/2025/10/10/run_batch_from_matrix.py`

**修正内容**:
- `convert_matrix_to_config`関数を修正
- 実験マトリックスの`experiment_plan`から`temperature`と`max_tokens`を読み込む
- デフォルト値の代わりに、マトリックスから取得した値を使用

**修正箇所**:
```python
# 現在（252-253行目）
'llm': {
    'model': exp_config.get('gpt_model', 'gpt-4o-mini'),
    'temperature': 0.7,  # ← ハードコード
    'max_tokens': 100    # ← ハードコード
},

# 修正後
'llm': {
    'model': exp_config.get('gpt_model', 'gpt-4o-mini'),
    'temperature': experiment_plan.get('temperature', 0.7),  # ← マトリックスから取得
    'max_tokens': experiment_plan.get('max_tokens', 100)      # ← マトリックスから取得
},
```

**注意**: `experiment_plan`を`convert_matrix_to_config`関数に渡す必要がある

### 3.4 パラメータ設定の追加方法

実験マトリックスの`experiment_plan`セクションに以下を追加:

```json
{
  "experiment_plan": {
    "total_experiments": 36,
    "created_at": "2025-11-26",
    "description": "メイン実験再実行: SemEval(4) + GoEmotions(28) + Steam(4) = 36実験",
    "settings": {
      "temperature": 0.0,
      "max_tokens": 2000,
      "few_shot": 0,
      "group_size": 100,
      "use_llm_evaluation": true,
      "llm_evaluation_model": "gpt-4o-mini",
      "llm_evaluation_temperature": 0.0
    }
  }
}
```

## 4. 実装手順

### Step 1: ディレクトリ構造の作成

```bash
mkdir -p 論文/結果/追加実験/main_experiment_rerun/{マトリックス,実行ファイル,results}
```

### Step 2: マトリックス生成スクリプトの作成

`実行ファイル/generate_main_experiment_matrix.py`を作成

### Step 3: バッチ実行スクリプトの修正

`run_batch_from_matrix.py`の`convert_matrix_to_config`関数を修正

### Step 4: マトリックスの生成

```bash
python 論文/結果/追加実験/main_experiment_rerun/実行ファイル/generate_main_experiment_matrix.py
```

### Step 5: 実験の実行

```bash
python src/analysis/experiments/2025/10/10/run_batch_from_matrix.py \
  --matrix 論文/結果/追加実験/main_experiment_rerun/マトリックス/main_experiment_matrix.json \
  --output-dir 論文/結果/追加実験/main_experiment_rerun/results \
  --background \
  --debug
```

### Step 6: 実行状態確認

```bash
python src/analysis/experiments/2025/10/10/run_batch_from_matrix.py \
  --status \
  --output-dir 論文/結果/追加実験/main_experiment_rerun/results
```

## 5. データセット詳細

### 5.1 SemEval-2014 ABSA

- **ドメイン**: Restaurant (food, service), Laptop (battery, screen)
- **実験数**: 4実験
- **アスペクト**:
  - Restaurant: food, service
  - Laptop: battery, screen

### 5.2 GoEmotions

- **ドメイン**: 感情分析
- **実験数**: 28実験
- **アスペクト**: 全28感情カテゴリ
  - admiration, amusement, anger, annoyance, approval, caring, confusion, curiosity, desire, disappointment, disapproval, disgust, embarrassment, excitement, fear, gratitude, grief, joy, love, nervousness, neutral, optimism, pride, realization, relief, remorse, sadness, surprise

### 5.3 Steam Review Aspect Dataset

- **ドメイン**: ゲームレビュー
- **実験数**: 4実験
- **アスペクト**: gameplay, visual, story, audio

## 6. 評価指標

- **BERTScore**: 意味類似度評価（主要指標）
- **BLEU Score**: n-gram一致率評価（参考指標）
- **LLM評価**: GPT-4o-miniによる意味的類似度評価（補助指標）

## 7. 期待される結果

- 全36実験が成功すること
- 各実験でBERTScore、BLEU Score、LLM評価スコアが算出されること
- パラメータ設定（temperature=0.0, max_tokens=2000, few_shot=0）が正しく適用されること

## 8. 注意事項

### 8.1 パラメータ設定の確認

- `run_batch_from_matrix.py`の修正が正しく反映されているか確認
- 実験マトリックスの`experiment_plan`に`temperature`と`max_tokens`が含まれているか確認

### 8.2 実行時間の見積もり

- 1実験あたり約10-30秒（API呼び出し時間含む）
- 36実験の合計実行時間: 約6-18分（順次実行の場合）
- 並列実行（2並列）の場合: 約3-9分

### 8.3 コスト見積もり

- gpt-4o-mini: 約$0.15/1M tokens（入力）+ $0.60/1M tokens（出力）
- max_tokens=2000に増加したため、出力トークン数が増加する可能性
- 36実験の概算コスト: 数ドル〜数十ドル

## 9. 実装チェックリスト

- [ ] ディレクトリ構造の作成
- [ ] マトリックス生成スクリプトの作成
- [ ] `run_batch_from_matrix.py`の修正
- [ ] マトリックスの生成
- [ ] マトリックス内容の確認
- [ ] 実験の実行
- [ ] 実行状態の確認
- [ ] 結果の確認（パラメータ設定が正しく適用されているか）
- [ ] READMEとドキュメントの作成

