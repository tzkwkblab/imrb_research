---
description: 分析ワークフローと実験管理のルール
globs: 
alwaysApply: true
---
# 分析ワークフローと実験管理ルール

## 実験管理構造

### ディレクトリ構造
```
src/analysis/experiments/{YYYY}/{MM}/{DD-実験番号}/
├── experiment_config.py
├── analysis_notebook.ipynb
├── results/
└── dataset_prompt.txt
```

### 実験番号: `06-1`, `06-2`, `06-3`

## データアクセス

```python
# 外部データ読み込み
data_dir = "data/external/amazon-product-reviews/kaggle-bittlingmayer/current/"

# 結果保存
results_dir = "data/processed/amazon-reviews/analysis-results/{experiment_date}/"
```

## 命名規則

- ファイル: `{機能}_{対象データ}_{手法}.py`
- クラス: `AmazonReviewAnalyzer`
- 関数: `load_review_data()`

## 必須コンポーネント

### 基本設定
```python
import os, logging
from dotenv import load_dotenv
from tqdm import tqdm

load_dotenv()
api_key = os.getenv('API_KEY')

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)
```

### Utilsライブラリ（必須）
```python
import sys
from pathlib import Path

utils_dir = Path(__file__).parent.parent / "utils"
sys.path.append(str(utils_dir))
sys.path.append(str(utils_dir / "LLM"))

# スコア計算
from get_score import calculate_scores
bert_score, bleu_score = calculate_scores(text_a, text_b)

# プロンプト生成
from prompt_contrast_factor import generate_contrast_factor_prompt
prompt, config = generate_contrast_factor_prompt(group_a, group_b)

# LLM使用
from LLM.llm_factory import LLMFactory
client = LLMFactory.create_client()
response = client.ask("質問文")

# 対比因子分析
from contrast_factor_analyzer import ContrastFactorAnalyzer
analyzer = ContrastFactorAnalyzer()
result = analyzer.analyze(group_a, group_b, correct_answer, output_dir)
```

## 必須パターン

- **スコア計算**: `utils/get_score.py`を使用
- **LLM呼び出し**: `utils/LLM/llm_factory.py`を使用
- **対比因子実験**: `utils/contrast_factor_analyzer.py`を使用

## 出力規則

- 結果は日付付きJSON形式で保存
- 実行時刻・パラメータ・データセットバージョンを記録
- 長時間処理には進捗保存機能を実装