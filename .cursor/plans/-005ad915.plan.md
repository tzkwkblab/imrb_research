<!-- 005ad915-ca23-45a0-a78b-2f4886a86c64 2b048ef2-75b1-4a08-9e66-aa461269d16c -->
# 実験結果考察システム構築計画

## 概要

実験結果JSONを効率的にLLM（gpt-5.1）に読み込ませ、単語レベルでの詳細考察を行い、階層的にログをまとめて最終的に実験ごとのMDレポートを生成する。

## 実装コンポーネント

### 1. 研究背景抽出モジュール

**ファイル**: `src/analysis/experiments/2025/10/10/extract_research_context.py`

- 論文texファイル（`論文/masterThesisJaSample.tex`）から研究背景・経緯を抽出
- 序章・関連研究・問題設定・目的を要約
- Markdown形式で`results/20251119_153853/analysis_workspace/research_context.md`に保存
- 後でLLMプロンプトに組み込むためのコンテキストとして使用

### 2. 実験結果考察スクリプト（メイン）

**ファイル**: `src/analysis/experiments/2025/10/10/analyze_experiment_results.py`

#### 2.1 個別実験考察フェーズ

- `analysis_workspace`から実験リストを読み込み
- 各実験のJSONを効率的にLLMに提示（group_a/group_bのサンプル、スコア、正解ラベルなど）
- 研究背景コンテキストを含むプロンプトで詳細考察を依頼
  - 単語レベルでの特徴分析
  - 文脈・意味的ニュアンスの考察
  - 正解ラベルとの比較
- LLM応答をログとして保存（`analysis_workspace/logs/{experiment_id}/analysis_{timestamp}.log`）

#### 2.2 実験カテゴリ単位考察フェーズ

- カテゴリごとにログを集約（メイン実験全体、steam_group_size、steam_gpt51、retrieved_concepts）
- 集約ログをLLMに読み込ませてカテゴリ単位の考察を生成
- カテゴリ単位のログを保存

#### 2.3 MDレポート生成フェーズ

- 個別実験の考察ログを読み込み
- 実験ごとにMDファイルを生成（`analysis_workspace/reports/{experiment_id}.md`）
- カテゴリ単位の考察も含める

### 3. プロンプト設計

#### 3.1 個別実験考察プロンプト

- 研究背景・目的の説明
- 実験設定（データセット、アスペクト、group_sizeなど）
- 入力データ（group_a/group_bの代表サンプル、正解ラベル）
- 出力結果（LLM応答、スコア）
- 考察指示：単語レベルでの特徴、文脈分析、意味的ニュアンス、正解との比較

#### 3.2 カテゴリ単位考察プロンプト

- カテゴリの目的・設定
- 個別実験の考察ログをまとめて提示
- カテゴリ全体の傾向・パターン・洞察を抽出

### 4. データ構造

```
analysis_workspace/
├── research_context.md           # 研究背景（新規作成）
├── logs/
│   ├── {experiment_id}/
│   │   ├── analysis_{timestamp}.log  # 個別実験考察ログ
│   └── category_{category_name}/
│       └── summary_{timestamp}.log   # カテゴリ単位考察ログ
└── reports/
    └── {experiment_id}.md        # 実験ごとのMDレポート
```

## 実装の詳細

### プロンプト生成関数

- `generate_experiment_analysis_prompt()`: 個別実験用プロンプト生成
- `generate_category_analysis_prompt()`: カテゴリ単位用プロンプト生成
- JSONデータを効率的に提示（長すぎる場合はサンプリング）

### LLM呼び出し

- `LLMFactory.create_client(model_name="gpt-5.1")`を使用
- エラーハンドリングとリトライ機能
- 応答をログファイルに保存

### ログ管理

- タイムスタンプ付きログファイル
- JSON形式でメタデータも保存
- 中断・再開に対応（チェックポイント機能）

## 実行フロー

1. 研究背景抽出（1回のみ）
2. 個別実験考察ループ（全71実験）
3. カテゴリ単位考察（メイン実験、各サブカテゴリ）
4. MDレポート生成（全実験）

## 注意事項

- gpt-5.1が利用不可の場合はgpt-4oにフォールバック
- プロンプト長制限に注意（長いgroup_a/group_bはサンプリング）
- APIコストとレート制限を考慮した実装

### To-dos

- [ ] 研究背景抽出モジュール作成: texファイルから研究背景・経緯を抽出してMDファイルに保存
- [ ] 実験結果考察スクリプト作成: 個別実験→カテゴリ単位の階層的考察を実装
- [ ] プロンプト生成ロジック実装: 研究背景を含む詳細考察プロンプトとカテゴリ単位プロンプト
- [ ] ログ管理機能実装: タイムスタンプ付きログ保存、チェックポイント機能
- [ ] MDレポート生成機能実装: 実験ごとの考察をMDファイルに出力